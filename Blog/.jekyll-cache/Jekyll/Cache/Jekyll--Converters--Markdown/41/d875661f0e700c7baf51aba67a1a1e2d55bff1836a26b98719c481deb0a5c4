I"^­<p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒã€‚
Node.js ä½¿ç”¨äº†ä¸€ä¸ªäº‹ä»¶é©±åŠ¨ã€éé˜»å¡å¼ I/O çš„æ¨¡å‹ï¼Œä½¿å…¶è½»é‡åˆé«˜æ•ˆã€‚
Node.js çš„åŒ…ç®¡ç†å™¨ npmï¼Œæ˜¯å…¨çƒæœ€å¤§çš„å¼€æºåº“ç”Ÿæ€ç³»ç»Ÿã€‚</p>

<h3 id="nodeä¸­çš„æ¨¡å—å¯¼å…¥å’Œå¯¼å‡º">nodeä¸­çš„æ¨¡å—å¯¼å…¥å’Œå¯¼å‡º</h3>

<ul>
  <li>
    <p>åœ¨nodeä¸­ä½¿ç”¨<code class="highlighter-rouge">module.exports</code>å¯¼å‡ºä¸€ä¸ªæ¨¡å—</p>
  </li>
  <li>
    <p>åœ¨nodeä¸­ä½¿ç”¨<code class="highlighter-rouge">require</code>å¯¼å…¥ä¸€ä¸ªæ¨¡å—</p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">a</span><span class="o">+</span><span class="nx">b</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">add</span><span class="c1">//å¯¼å‡ºä¸€ä¸ªæ¨¡å—</span>
  
<span class="kd">const</span> <span class="nx">add</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./index</span><span class="dl">"</span><span class="p">)</span><span class="c1">//å¯¼å…¥ä¸€ä¸ªæ¨¡å—ï¼Œå…¶ä¸­requireæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªè·¯å¾„ä½œä¸ºå‚æ•°</span>
<span class="kd">const</span> <span class="nx">sum</span><span class="o">=</span><span class="nx">add</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">sum</span><span class="p">)</span>
  
<span class="c1">//åœ¨å¯¼å…¥æ¨¡å—çš„è¿‡ç¨‹ä¸­å¯ä»¥æŒ‰éœ€å¯¼å…¥ï¼Œå‰ææ˜¯å¯¼å‡ºçš„æ˜¯ä¸€ä¸ªå¯¹è±¡=&gt;es6ä¸­çš„è§£æ„èµ‹å€¼</span>
<span class="kd">const</span> <span class="p">{</span><span class="nx">name</span><span class="p">,</span><span class="nx">add</span><span class="p">}</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./index</span><span class="dl">"</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="åœ¨nodeä¸­åˆ›å»ºä¸€ä¸ªhttpæœåŠ¡">åœ¨nodeä¸­åˆ›å»ºä¸€ä¸ªhttpæœåŠ¡</h3>

<ul>
  <li>
    <p>é€šè¿‡<code class="highlighter-rouge">http</code>æ¨¡å—åˆ›å»ºä¸€ä¸ªhttpæœåŠ¡</p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//http.createServeråˆ›å»ºä¸€ä¸ªhttpæœåŠ¡</span>
<span class="c1">//è·å–è¯·æ±‚å¤´req.headers["content-type"]</span>
<span class="kd">const</span> <span class="nx">server</span><span class="o">=</span><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="c1">// writeHead()æ–¹æ³•ç”¨äºè®¾ç½®å“åº”æ•°æ®çš„å“åº”å¤´headers</span>
    <span class="c1">//ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå“åº”çš„çŠ¶æ€ç ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå“åº”å¤´</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,{</span><span class="dl">"</span><span class="s2">content-type</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">text/html</span><span class="dl">"</span><span class="p">})</span><span class="c1">//è®¾ç½®å“åº”æ•°æ®çš„å“åº”å¤´</span>
  
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">"</span><span class="s2">&lt;h1&gt;hello word&lt;/h1&gt;</span><span class="dl">"</span><span class="p">)</span><span class="c1">//å‘é€å“åº”ä¿¡æ¯</span>
<span class="p">})</span>
  
<span class="c1">//ç›‘å¬ä¸€ä¸ª3000ç«¯å£</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">,()</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">åˆ›å»ºä¸€ä¸ªhttpæœåŠ¡æˆåŠŸ</span><span class="dl">"</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>å¤„ç†getè¯·æ±‚</p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">http</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">http</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">querystring</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">querystring</span><span class="dl">"</span><span class="p">);</span>
  
<span class="kd">const</span> <span class="nx">server</span><span class="o">=</span><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">)</span><span class="c1">//è¿”å›è¯·æ±‚çš„æ–¹å¼</span>
    <span class="kd">const</span> <span class="nx">url</span><span class="o">=</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">è¯·æ±‚çš„urlåœ°å€:</span><span class="dl">"</span><span class="o">+</span><span class="nx">url</span><span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="o">=</span><span class="nx">querystring</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">"</span><span class="s2">?</span><span class="dl">"</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="c1">//parseé»˜è®¤ä½¿ç”¨&amp;åˆ†å‰²æŸ¥è¯¢å­—ç¬¦ä¸²</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span>
        <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span><span class="c1">//å‘å‰ç«¯è¿”å›jsonæ ¼å¼çš„æ•°æ®</span>
    <span class="p">)</span>
<span class="p">})</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">,()</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">åˆ›å»ºæœåŠ¡æˆåŠŸ</span><span class="dl">"</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>å¤„ç†postè¯·æ±‚</p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">http</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">http</span><span class="dl">"</span><span class="p">);</span>
  
<span class="kd">const</span> <span class="nx">server</span><span class="o">=</span><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="o">===</span><span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">){</span>
        <span class="c1">//reqçš„æ•°æ®æ ¼å¼</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">req content-typeï¼š</span><span class="dl">"</span><span class="o">+</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">content-type</span><span class="dl">'</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="c1">//æ¥æ”¶åˆ°çš„æ•°æ®</span>
    <span class="kd">let</span> <span class="nx">postData</span><span class="o">=</span><span class="dl">""</span><span class="p">;</span>
  
    <span class="c1">//ç›‘å¬è¯·æ±‚æ•°æ®çš„å‘é€</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">data</span><span class="dl">"</span><span class="p">,</span><span class="nx">chunk</span><span class="o">=&gt;</span><span class="p">{</span>
        <span class="nx">postData</span><span class="o">+=</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
    <span class="p">})</span>
    <span class="c1">//ç›‘å¬æ•°æ®å‘é€ç»“æŸ</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">end</span><span class="dl">"</span><span class="p">,()</span><span class="o">=&gt;</span><span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">postData</span><span class="p">)</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">"</span><span class="s2">è¯·æ±‚å‘é€æˆåŠŸ</span><span class="dl">"</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">})</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>nodeç»¼åˆå¤„ç†getå’Œpostè¯·æ±‚</p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">http</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">http</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">querystring</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">querystring</span><span class="dl">"</span><span class="p">);</span>
  
<span class="kd">const</span> <span class="nx">server</span><span class="o">=</span><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
<span class="kd">const</span> <span class="nx">method</span><span class="o">=</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">;</span><span class="c1">//è·å–è¯·æ±‚çš„æ–¹å¼</span>
  
<span class="kd">const</span> <span class="nx">url</span><span class="o">=</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span><span class="c1">//è·å–å‰ç«¯è¯·æ±‚çš„urlåœ°å€</span>
  
<span class="kd">const</span> <span class="nx">path</span><span class="o">=</span><span class="nx">url</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">"</span><span class="s2">?</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="c1">//è·å–å‰ç«¯çš„ç½‘é¡µåœ°å€</span>
  
<span class="kd">const</span> <span class="nx">query</span><span class="o">=</span><span class="nx">querystring</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">"</span><span class="s2">?</span><span class="dl">"</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="c1">//è·å–æŸ¥è¯¢å­—ç¬¦ä¸²</span>
  
   <span class="c1">//è®¾ç½®è¿”å›çš„æ•°æ®ä¸ºjson</span>
  
   <span class="c1">//è®¾ç½®å“åº”æ•°æ®çš„å“åº”å¤´</span>
   <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-type</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span><span class="p">);</span>
   <span class="c1">//è¿”å›çš„æ•°æ®</span>
    <span class="kd">const</span> <span class="nx">resData</span><span class="o">=</span><span class="p">{</span>
        <span class="nx">method</span><span class="p">,</span><span class="nx">url</span><span class="p">,</span><span class="nx">path</span><span class="p">,</span><span class="nx">query</span>
    <span class="p">}</span>
  
    <span class="k">if</span><span class="p">(</span><span class="nx">method</span><span class="o">===</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span>
            <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">resData</span><span class="p">)</span><span class="c1">//è®¾ç½®è¿”å›å­—ç¬¦ä¸²çš„æ ¼å¼</span>
        <span class="p">)</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">method</span><span class="o">===</span><span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">){</span>
        <span class="kd">let</span> <span class="nx">postData</span><span class="o">=</span><span class="dl">""</span>
        <span class="c1">//ç›‘å¬å‰ç«¯å‘é€è¿‡æ¥çš„æ•°æ®ï¼Œå½“å‰ç«¯æœ‰æ•°æ®å‘é€è¿‡æ¥æ—¶ï¼Œä¼ é€’ç»™chunk</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">data</span><span class="dl">"</span><span class="p">,(</span><span class="nx">chunk</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
            <span class="nx">postData</span><span class="o">=</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="p">})</span>
  
        <span class="c1">//ç›‘å¬å‰ç«¯å‘é€æ•°æ®ç»“æŸï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">end</span><span class="dl">"</span><span class="p">,()</span><span class="o">=&gt;</span><span class="p">{</span>
            <span class="nx">resData</span><span class="p">.</span><span class="nx">postData</span><span class="o">=</span><span class="nx">postData</span><span class="p">;</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span>
                <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">resData</span><span class="p">)</span><span class="c1">//è®¾ç½®è¿”å›å­—ç¬¦ä¸²çš„æ ¼å¼</span>
            <span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span>
  
<span class="p">})</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="nodemonä½¿ç”¨">nodemonä½¿ç”¨</h3>

<ul>
  <li>
    <p>nodemonæ£€æµ‹æ–‡ä»¶å˜åŒ–ï¼Œè‡ªåŠ¨é‡å¯node</p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//å®‰è£…nodemon     cnpm i nodemon -g</span>
<span class="c1">//å®‰è£…cross-env   cnpm i cross-env -S</span>
  
<span class="c1">//é…ç½®</span>
<span class="dl">"</span><span class="s2">scripts</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">echo </span><span class="se">\"</span><span class="s2">Error: no test specified</span><span class="se">\"</span><span class="s2"> &amp;&amp; exit 1</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">dev</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">cross-env NODE_ENV=dev nodemon ./bin/www.js</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">prd</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">cross-env NODE_ENV=production nodemon ./bin/www.js</span><span class="dl">"</span>
<span class="p">}</span>
  
<span class="c1">//åˆ›å»ºå“åº”æ–‡ä»¶ ./bin/www.js</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><code class="highlighter-rouge">cross-env</code>æ˜¯ç”¨æ¥è®¾ç½®ä¸åŒçš„è¿è¡Œç¯å¢ƒ</p>
  </li>
</ul>

<h3 id="nodeä¸­çš„cookieå’Œsession">nodeä¸­çš„cookieå’Œsession</h3>

<h4 id="cookie">cookie</h4>

<ul>
  <li>å­˜å‚¨åœ¨æµè§ˆå™¨ä¸­çš„ä¸€æ®µå­—ç¬¦ä¸²(æœ€å¤§5kb)</li>
  <li>è·¨åŸŸä¸å…±äº«</li>
</ul>

<h4 id="serveræ“ä½œcookie">serveræ“ä½œcookie</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//è·å–cookie</span>
<span class="c1">//è§£æcookie</span>
<span class="nx">req</span><span class="p">.</span><span class="nx">cookie</span><span class="o">=</span><span class="p">{}</span>
<span class="kd">const</span> <span class="nx">cookieStr</span><span class="o">=</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span><span class="o">||</span><span class="dl">""</span><span class="c1">//cookieçš„æ ¼å¼æ˜¯k1=1;k2=2;k3=3</span>
<span class="nx">cookieStr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">"</span><span class="s2">;</span><span class="dl">"</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">item</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">item</span><span class="p">){</span>
        <span class="k">return</span> 
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">arr</span><span class="o">=</span><span class="nx">item</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">"</span><span class="s2">=</span><span class="dl">"</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">key</span><span class="o">=</span><span class="nx">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="kd">const</span> <span class="nx">val</span><span class="o">=</span><span class="nx">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nx">req</span><span class="p">.</span><span class="nx">cookie</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">=</span><span class="nx">val</span>
<span class="p">})</span>

<span class="c1">//è®¾ç½®cookieçš„å€¼ï¼Œpathå‚æ•°è¡¨ç¤ºè¿™ä¸ªcookieå¯ä»¥åœ¨æ‰€æœ‰çš„ç½‘é¡µéƒ½èƒ½è®¿é—®ï¼ŒhttpOnlyå‚æ•°é™åˆ¶cookieä¸èƒ½ä¿®æ”¹</span>
<span class="c1">//expireså‚æ•°è®¾ç½®cookieçš„è¿‡æœŸæ—¶é—´</span>
<span class="kd">const</span> <span class="nx">getCookieExpire</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="nx">d</span><span class="p">.</span><span class="nx">setTime</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">toGMTString</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Set-Cookie</span><span class="dl">"</span><span class="p">,</span> <span class="s2">`username=</span><span class="p">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">username</span><span class="p">}</span><span class="s2">;path=/;httpOnly;expires=</span><span class="p">${</span><span class="nx">getCookieExpire</span><span class="p">()}</span><span class="s2">`</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="session">session</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">SESSION_DATA</span> <span class="o">=</span> <span class="p">{}</span>
 <span class="c1">//è§£æsession</span>
<span class="kd">let</span> <span class="nx">needSetCookie</span><span class="o">=</span><span class="kc">false</span><span class="c1">//æ ‡å¿—useridæ˜¯å¦å·²ç»å­˜åœ¨</span>
<span class="kd">let</span> <span class="nx">userId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">userid</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">userId</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">SESSION_DATA</span><span class="p">[</span><span class="nx">userId</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">SESSION_DATA</span><span class="p">[</span><span class="nx">userId</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
    <span class="nx">needSetCookie</span><span class="o">=</span><span class="kc">true</span>
    <span class="nx">userId</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()}</span><span class="s2">_</span><span class="p">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()}</span><span class="s2">`</span>
    <span class="nx">SESSION_DATA</span><span class="p">[</span><span class="nx">userId</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="p">}</span>
<span class="nx">req</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="nx">SESSION_DATA</span><span class="p">[</span><span class="nx">userId</span><span class="p">]</span>
<span class="c1">//è®¾ç½®æ•°æ®</span>
<span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">username</span><span class="o">=</span><span class="nx">data</span><span class="p">.</span><span class="nx">username</span><span class="p">;</span>
<span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">realName</span><span class="o">=</span><span class="nx">data</span><span class="p">.</span><span class="nx">realName</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="redis">redis</h3>

<ul>
  <li>web serveræœ€å¸¸ç”¨çš„ç¼“å­˜æ•°æ®åº“ï¼Œæ•°æ®å­˜æ”¾åœ¨å†…å­˜ä¸­</li>
  <li>ç›¸æ¯”äºmysqlï¼Œè®¿é—®é€Ÿåº¦å¿«ï¼ˆå†…å­˜å’Œç¡¬ç›˜ä¸æ˜¯ä¸€ä¸ªæ•°é‡çº§çš„ï¼‰</li>
  <li>æˆæœ¬é«˜ï¼Œå¯å­˜å‚¨çš„æ•°æ®é‡å°</li>
  <li>å®‰è£…redis<code class="highlighter-rouge"> https://github.com/microsoftarchive/redis/releases </code></li>
  <li>
    <p>å¯åŠ¨redis</p>

    <ul>
      <li>æ‰“å¼€ä¸€ä¸ªcmdçª—å£è¿›å…¥rediså®‰è£…ç›®å½•<code class="highlighter-rouge">redis-server.exe redis.windows.conf</code></li>
      <li>åœ¨redisç›®å½•ä¸‹å†æ‰“å¼€ä¸€ä¸ªcmd<code class="highlighter-rouge">redis-cli.exe -h 127.0.0.1 -p 6379</code></li>
    </ul>
  </li>
</ul>

<h3 id="nodeä¸­ä½¿ç”¨redis">nodeä¸­ä½¿ç”¨redis</h3>

<ul>
  <li>å®‰è£…redis<code class="highlighter-rouge">cnpm i redis -S</code></li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//å¯¼å…¥redisæ¨¡å—</span>
<span class="kd">const</span> <span class="nx">redis</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">redis</span><span class="dl">"</span><span class="p">)</span>

<span class="c1">//åˆ›å»ºrediså®¢æˆ·ç«¯ ç«¯å£å¯¹åº”rediså¯åŠ¨æ—¶çš„ç«¯å£å·</span>
<span class="kd">const</span> <span class="nx">redisClient</span><span class="o">=</span><span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="mi">6379</span><span class="p">,</span><span class="dl">"</span><span class="s2">127.0.0.1</span><span class="dl">"</span><span class="p">)</span>

<span class="c1">//ç›‘å¬rediså®¢æˆ·ç«¯æ˜¯å¦å‘ç”Ÿå¼‚å¸¸</span>
<span class="nx">redisClient</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">,</span><span class="nx">err</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1">//æµ‹è¯•  redis.printè®¾ç½®äº†è¿™ä¸ªå‚æ•°ä¼šæ‰“å°å‡ºè®¾ç½®æ˜¯å¦æˆåŠŸ</span>
<span class="c1">//å‘redisä¸­æ·»åŠ æ•°æ®</span>
<span class="nx">redisClient</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">myname</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">å¼ ä¸‰</span><span class="dl">"</span><span class="p">,</span><span class="nx">redis</span><span class="p">.</span><span class="nx">print</span><span class="p">)</span>

<span class="c1">//è·å–redisä¸­çš„æ•°æ®</span>
<span class="nx">redisClient</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">myname</span><span class="dl">"</span><span class="p">,(</span><span class="nx">err</span><span class="p">,</span><span class="nx">val</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>

    <span class="c1">//é€€å‡º</span>
    <span class="nx">redisClient</span><span class="p">.</span><span class="nx">quit</span><span class="p">()</span>
<span class="p">})</span>
</code></pre></div></div>

<ul>
  <li>
    <p>å¯¹è·å–æ•°æ®å’Œè®¾ç½®æ•°æ®çš„å°è£…</p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="kd">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//æµ‹è¯• redis.printè®¾ç½®äº†è¿™ä¸ªå‚æ•°ä¼šæ‰“å°å‡ºè®¾ç½®æ˜¯å¦æˆåŠŸ</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">val</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">object</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">val</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">redisClient</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">print</span><span class="p">)</span>
<span class="p">}</span>
  
<span class="kd">function</span> <span class="kd">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">redisClient</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="p">}</span>
  
            <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
  
                <span class="k">return</span> <span class="nx">resolve</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
            <span class="p">}</span>
  
            <span class="k">try</span> <span class="p">{</span>
                <span class="nx">resolve</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">val</span><span class="p">))</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">resolve</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="nginx">nginx</h3>

<ul>
  <li>
    <p><a href="https://blog.csdn.net/u011418717/article/details/52776090">åŸºæœ¬ä½¿ç”¨æ–¹å¼</a></p>
  </li>
  <li>
    <p>é«˜æ€§èƒ½çš„webæœåŠ¡å™¨ï¼Œå¼€æºå…è´¹</p>
  </li>
  <li>
    <p>ä¸€èˆ¬ç”¨äºåšé™æ€æœåŠ¡ï¼Œè´Ÿè½½å‡è¡¡</p>
  </li>
  <li>
    <p>åå‘ä»£ç†(å¯¹å®¢æˆ·ç«¯ä¸å¯è§çš„ä»£ç†,å®ç°å‰åç«¯è·¨åŸŸè®¿é—®)</p>
  </li>
  <li>
    <p>æµ‹è¯•é…ç½®æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®<code class="highlighter-rouge">nginx -t</code></p>
  </li>
  <li>
    <p>å¯åŠ¨<code class="highlighter-rouge"> start nginx </code>ï¼Œé‡å¯<code class="highlighter-rouge">nginx -s reload</code></p>
  </li>
  <li>
    <p>åœæ­¢<code class="highlighter-rouge">nginx -s top</code></p>
  </li>
  <li>
    <p>é…ç½®</p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//é€šè¿‡serverå±æ€§é…ç½®å¤šä¸ªæœåŠ¡å™¨çš„åœ°å€ï¼Œå½“ä¸€ä¸ªæœåŠ¡å™¨ä¸èƒ½ä½¿ç”¨ï¼Œnginxè‡ªåŠ¨æ£€ç´¢ä¸‹ä¸€ä¸ª</span>
<span class="nx">upstream</span> <span class="nx">local_tomcat</span> <span class="p">{</span>  
    <span class="nx">server</span> <span class="nx">localhost</span><span class="p">:</span><span class="mi">8001</span><span class="p">;</span>  
    <span class="nx">server</span> <span class="nx">localhost</span><span class="p">:</span><span class="mi">4000</span><span class="p">;</span>  
<span class="p">}</span> 
<span class="nx">server</span> <span class="p">{</span>
    <span class="nx">listen</span>       <span class="mi">8080</span><span class="p">;</span><span class="c1">//nginxæœåŠ¡å™¨çš„ç«¯å£å·</span>
    <span class="nx">server_name</span>  <span class="nx">localhost</span><span class="p">;</span>
  
    <span class="nx">location</span> <span class="o">/</span><span class="p">{</span>
        <span class="nx">proxy_pass</span> <span class="na">http</span><span class="p">:</span><span class="c1">//localhost:8001;//å½“è®¿é—®127.0.0.1:8080/æ—¶nginxæœåŠ¡å™¨ä»£ç†é»˜è®¤è·³åˆ°http://localhost:8001</span>
        <span class="err">#</span><span class="nx">proxy_pass</span> <span class="na">http</span><span class="p">:</span><span class="c1">//local_tomcat =&gt;upstreamçš„ä½¿ç”¨</span>
    <span class="p">}</span>
    <span class="nx">location</span> <span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="p">{</span>
        <span class="nx">proxy_pass</span> <span class="na">http</span><span class="p">:</span><span class="c1">//localhost:8000;//å½“è®¿é—®127.0.0.1:8080/api/æ—¶nginxæœåŠ¡å™¨ä»£ç†é»˜è®¤è·³åˆ°http://localhost:8000</span>
        <span class="nx">proxy_set_header</span> <span class="nx">Host</span> <span class="nx">$host</span><span class="p">;</span><span class="c1">//ç”±äºè®¿é—®çš„åœ°å€æ˜¯localhost:8080/api/...,è€Œå®é™…éœ€è¦è®¿é—®çš„åœ°å€æ˜¯http://localhost:8000/api/...,ä¸¤ä¸ªçš„è¯·æ±‚å¤´localhost:8080(localhost:8000)ä¸ç›¸åŒï¼Œå¦‚æœåç«¯è®¾ç½®æœ‰è¯·æ±‚å¤´é™åˆ¶æ¯”å¦‚åªèƒ½è®¿é—®localhost:8000ï¼Œé‚£ä¹ˆå°±ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥è®¾ç½®proxy_set_header Host $hostå°±æ˜¯ä¸ºäº†å½“åœ¨å‘åç«¯å‘é€è¯·æ±‚æ—¶ï¼ŒæŒ‡å®šè¯·æ±‚å¤´ä¸º proxy_passæŒ‡å®šçš„å€¼</span>
    <span class="p">}</span>
  
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="nodeæ“ä½œæ–‡ä»¶">nodeæ“ä½œæ–‡ä»¶</h3>

<ul>
  <li>è¯»å–æ–‡ä»¶</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//è¯»å–æ–‡ä»¶çš„æ¨¡å—</span>
<span class="kd">const</span> <span class="nx">fs</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">fs</span><span class="dl">"</span><span class="p">)</span>
<span class="c1">//æ‹¼æ¥æ–‡ä»¶è·¯å¾„çš„æ¨¡å—</span>
<span class="kd">const</span> <span class="nx">path</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">path</span><span class="dl">"</span><span class="p">)</span><span class="c1">//ç”¨äºæ‹¼æ¥è·¯å¾„ï¼Œç”±äºä¸èƒ½çš„ç³»ç»Ÿè·¯å¾„ä¸ä¸€æ ·ï¼Œå› æ­¤ä½¿ç”¨è¿™ä¸ªæ¨¡å—ï¼Œèƒ½å¤Ÿä¿è¯è·¯å¾„çš„ç»Ÿä¸€</span>
<span class="kd">const</span> <span class="nx">filename</span><span class="o">=</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="dl">"</span><span class="s2">data.txt</span><span class="dl">"</span><span class="p">)</span><span class="c1">//è·å–å½“å‰ç›®å½•ä¸‹çš„data.txtæ–‡ä»¶çš„è·¯å¾„å</span>

<span class="c1">//è¯»å–æ–‡ä»¶å†…å®¹</span>
<span class="c1">//å‚æ•°1ä¸ºæ–‡ä»¶çš„è·¯å¾„ï¼Œå‚æ•°2ä¸ºå›è°ƒå‡½æ•°</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">,(</span><span class="nx">err</span><span class="p">,</span><span class="nx">data</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
<span class="p">})</span>
</code></pre></div></div>

<ul>
  <li>å†™å…¥æ–‡ä»¶</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fs</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">fs</span><span class="dl">"</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">path</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">path</span><span class="dl">"</span><span class="p">)</span><span class="c1">//ç”¨äºæ‹¼æ¥è·¯å¾„ï¼Œç”±äºä¸èƒ½çš„ç³»ç»Ÿè·¯å¾„ä¸ä¸€æ ·ï¼Œå› æ­¤ä½¿ç”¨è¿™ä¸ªæ¨¡å—ï¼Œèƒ½å¤Ÿä¿è¯è·¯å¾„çš„ç»Ÿä¸€</span>

<span class="kd">const</span> <span class="nx">filename</span><span class="o">=</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="dl">"</span><span class="s2">data.txt</span><span class="dl">"</span><span class="p">)</span><span class="c1">//è·å–å½“å‰ç›®å½•ä¸‹çš„data.txtæ–‡ä»¶çš„è·¯å¾„å</span>

<span class="c1">//å†™å…¥æ–‡ä»¶</span>
<span class="kd">const</span> <span class="nx">content</span><span class="o">=</span><span class="dl">"</span><span class="s2">11111111111111111111111111111111</span><span class="dl">"</span>
<span class="kd">const</span> <span class="nx">opt</span><span class="o">=</span><span class="p">{</span>
    <span class="na">flag</span><span class="p">:</span><span class="dl">'</span><span class="s1">a</span><span class="dl">'</span><span class="p">,</span><span class="c1">//è¿½åŠ å†™å…¥,è¦†ç›–ç”¨'w'</span>
<span class="p">}</span>
<span class="c1">//å‚æ•°1æ˜¯å†™å…¥æ–‡ä»¶çš„è·¯å¾„ï¼Œ</span>
<span class="c1">//å‚æ•°2ä¸ºå‘æ–‡ä»¶å†™å…¥çš„å†…å®¹ï¼Œ</span>
<span class="c1">//å‚æ•°3ä¸ºå†™å…¥çš„æ–¹å¼ï¼Œaè¡¨ç¤ºè¿½åŠ å†™å…¥ï¼Œwè¦†ç›–å†™å…¥</span>
<span class="c1">//å‚æ•°4æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="nx">content</span><span class="p">,</span><span class="nx">opt</span><span class="p">,(</span><span class="nx">err</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<ul>
  <li>åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">exists</span><span class="p">(</span><span class="nx">filename</span><span class="p">,(</span><span class="nx">exist</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">exist</span><span class="p">)</span><span class="c1">//æ–‡ä»¶å­˜åœ¨è¿”å›trueï¼Œå¦åˆ™ä¸ºfalse</span>
<span class="p">})</span>
</code></pre></div></div>

<ul>
  <li>streamæ“ä½œæ–‡ä»¶</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">fs</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">path</span><span class="dl">"</span><span class="p">)</span>
<span class="c1">//è¢«è¯»å–çš„æ–‡ä»¶è·¯å¾„</span>
<span class="kd">const</span> <span class="nx">filename1</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">"</span><span class="s2">data1.txt</span><span class="dl">"</span><span class="p">)</span>
<span class="c1">//å†™å…¥å†…å®¹çš„æ–‡ä»¶è·¯å¾„</span>
<span class="kd">const</span> <span class="nx">filename2</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">"</span><span class="s2">data2.txt</span><span class="dl">"</span><span class="p">)</span>

<span class="c1">//è¯»å–æ–‡ä»¶çš„streamå¯¹è±¡</span>
<span class="kd">const</span> <span class="nx">readStream</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">filename1</span><span class="p">);</span>
<span class="c1">//å†™å…¥æ–‡ä»¶çš„streamå¯¹è±¡</span>
<span class="kd">const</span> <span class="nx">writeStream</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="nx">filename2</span><span class="p">);</span>

<span class="c1">//æ‰§è¡Œæ‹·è´ï¼Œé€šè¿‡pipe</span>
<span class="nx">readStream</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">writeStream</span><span class="p">);</span>
<span class="c1">//æ‹·è´ç»“æŸ</span>
<span class="nx">readStream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">end</span><span class="dl">"</span><span class="p">,(</span><span class="nx">err</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<ul>
  <li>
    <p>è¯·æ±‚è¯»å–æ–‡ä»¶</p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">path</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">path</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">fs</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">fs</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">http</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">http</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">filename1</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">"</span><span class="s2">data1.txt</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">filename2</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">"</span><span class="s2">data2.txt</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="o">===</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">){</span>
        <span class="kd">let</span> <span class="nx">postData</span><span class="o">=</span><span class="dl">""</span><span class="p">;</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">data</span><span class="dl">"</span><span class="p">,</span><span class="nx">chuck</span><span class="o">=&gt;</span><span class="p">{</span>
            <span class="nx">postData</span><span class="o">=</span><span class="nx">chuck</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span><span class="c1">//jsonæ ¼å¼çš„å­—ç¬¦ä¸²</span>
        <span class="p">})</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">end</span><span class="dl">"</span><span class="p">,()</span><span class="o">=&gt;</span><span class="p">{</span>
            <span class="nx">postData</span><span class="o">=</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">postData</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">postData</span><span class="p">.</span><span class="nx">filename</span><span class="o">===</span><span class="dl">"</span><span class="s2">data1</span><span class="dl">"</span><span class="p">){</span>
                <span class="c1">//è¯»å–æ–‡ä»¶çš„streamå¯¹è±¡</span>
                <span class="kd">const</span> <span class="nx">readStream</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">filename1</span><span class="p">);</span>
                <span class="nx">readStream</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">else</span><span class="p">{</span>
               <span class="c1">//è¯»å–æ–‡ä»¶çš„streamå¯¹è±¡</span>
               <span class="kd">const</span> <span class="nx">readStream</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">filename2</span><span class="p">);</span>
               <span class="nx">readStream</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> 
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8000</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>nodeå‘æ–‡ä»¶ä¸­å†™æ—¥å¿—</p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fs</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">fs</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">path</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">path</span><span class="dl">"</span><span class="p">)</span>
<span class="c1">//å†™æ—¥å¿—</span>
<span class="kd">function</span> <span class="nx">writeLog</span><span class="p">(</span><span class="nx">writeStream</span><span class="p">,</span><span class="nx">log</span><span class="p">){</span>
    <span class="nx">writeStream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">log</span><span class="o">+</span><span class="dl">"</span><span class="se">\n</span><span class="dl">"</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">//ç”Ÿæˆwrite Stream</span>
<span class="kd">function</span> <span class="nx">createWriteStream</span><span class="p">(</span><span class="nx">fileName</span><span class="p">){</span>
    <span class="c1">//æ—¥å¿—æ–‡ä»¶çš„å­˜å‚¨åœ°å€</span>
    <span class="kd">const</span> <span class="nx">fullFileName</span><span class="o">=</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="dl">"</span><span class="s2">../</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">../</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">logs</span><span class="dl">"</span><span class="p">,</span><span class="nx">fileName</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">writeStream</span><span class="o">=</span><span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="nx">fullFileName</span><span class="p">,{</span><span class="na">flags</span><span class="p">:</span><span class="dl">'</span><span class="s1">a</span><span class="dl">'</span><span class="p">})</span>
    <span class="k">return</span> <span class="nx">writeStream</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//å†™è®¿é—®æ—¥å¿—</span>
<span class="kd">const</span> <span class="nx">accessWriteStream</span><span class="o">=</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="dl">'</span><span class="s1">access.log</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">function</span> <span class="nx">access</span><span class="p">(</span><span class="nx">log</span><span class="p">){</span>
    <span class="nx">writeLog</span><span class="p">(</span><span class="nx">accessWriteStream</span><span class="p">,</span><span class="nx">log</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="p">{</span>
    <span class="nx">access</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="nodeä¸­çš„md5åŠ å¯†">nodeä¸­çš„md5åŠ å¯†</h3>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">crypto</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">crypto</span><span class="dl">"</span><span class="p">);</span>

<span class="c1">//å¯†åŒ™</span>
<span class="kd">const</span> <span class="nx">SECRET_KEY</span><span class="o">=</span><span class="dl">"</span><span class="s2">123456</span><span class="dl">"</span>

<span class="c1">//md5åŠ å¯†</span>
<span class="kd">function</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">content</span><span class="p">){</span>
    <span class="kd">let</span> <span class="nx">md5</span><span class="o">=</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="dl">"</span><span class="s2">md5</span><span class="dl">"</span><span class="p">);</span><span class="c1">//åˆ›å»ºä¸€ä¸ªhashå¯¹è±¡ï¼Œåˆ›å»ºhashå¯¹è±¡ä½¿ç”¨çš„ç®—æ³•æ˜¯md5</span>
    <span class="c1">//md5.update(content)ä½¿ç”¨ç»™å®šçš„contentæ›´æ–°hashå¯¹è±¡çš„å†…å®¹ï¼Œ.digest("hex")ä½¿ç”¨ç›¸åº”çš„å­—ç¬¦ç¼–ç è¿”å›hashå€¼</span>
    <span class="k">return</span> <span class="nx">md5</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">content</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="dl">"</span><span class="s2">hex</span><span class="dl">"</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">//åŠ å¯†å‡½æ•°</span>
<span class="kd">function</span> <span class="nx">getPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">){</span>
    <span class="kd">const</span> <span class="nx">str</span><span class="o">=</span><span class="s2">`password=</span><span class="p">${</span><span class="nx">password</span><span class="p">}</span><span class="s2">&amp;key=</span><span class="p">${</span><span class="nx">SECRET_KEY</span><span class="p">}</span><span class="s2">`</span>
    <span class="k">return</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">getPassword</span><span class="p">(</span><span class="mi">123</span><span class="p">))</span>
</code></pre></div></div>

<h3 id="nodeä¸­è¿æ¥æ•°æ®åº“">nodeä¸­è¿æ¥æ•°æ®åº“</h3>

<ul>
  <li>
    <p>å®‰è£…mysqlæ¨¡å—<code class="highlighter-rouge">cnpm i mysql -S</code></p>
  </li>
  <li>
    <p><a href="https://www.cnblogs.com/zjx2011/p/6380579.html#establishing-connect">mysqlæ¨¡å—çš„ç®€ä»‹</a></p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//å¯¼å…¥mysqlæ¨¡å—</span>
<span class="kd">const</span> <span class="nx">mysql</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">mysql</span><span class="dl">"</span><span class="p">)</span>
<span class="c1">//åˆ›å»ºæ•°æ®åº“è¿æ¥å¯¹è±¡</span>
<span class="kd">const</span> <span class="nx">conn</span><span class="o">=</span><span class="nx">mysql</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">({</span>
    <span class="na">host</span><span class="p">:</span><span class="dl">"</span><span class="s2">localtion</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">host</span><span class="p">:</span><span class="dl">"</span><span class="s2">localhost</span><span class="dl">"</span><span class="p">,</span><span class="c1">//æ•°æ®åº“è¿æ¥çš„ipåœ°å€</span>
    <span class="na">user</span><span class="p">:</span><span class="dl">"</span><span class="s2">root</span><span class="dl">"</span><span class="p">,</span><span class="c1">//è¿æ¥æ•°æ®åº“çš„ç”¨æˆ·å</span>
    <span class="na">password</span><span class="p">:</span><span class="dl">"</span><span class="s2">root</span><span class="dl">"</span><span class="p">,</span><span class="c1">//è¿æ¥æ•°æ®åº“çš„å¯†ç </span>
    <span class="na">port</span><span class="p">:</span><span class="dl">"</span><span class="s2">3306</span><span class="dl">"</span><span class="p">,</span><span class="c1">//æ•°æ®åº“çš„ç«¯å£å·</span>
    <span class="na">database</span><span class="p">:</span><span class="dl">"</span><span class="s2">myblog</span><span class="dl">"</span><span class="c1">//æ•°æ®åº“çš„åç§°</span>
<span class="p">})</span>
<span class="c1">//å¼€å§‹è¿æ¥æ•°æ®åº“</span>
<span class="nx">conn</span><span class="p">.</span><span class="nx">connect</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">})</span>
<span class="c1">//å°è£…çš„ä¸€ä¸ªè¿›è¡Œå¢åˆ æ”¹æŸ¥çš„å‡½æ•°</span>
<span class="kd">function</span> <span class="nx">exec</span><span class="p">(</span><span class="nx">sql</span><span class="p">){</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
        <span class="nx">con</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,(</span><span class="nx">err</span><span class="p">,</span><span class="nx">result</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
                <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="expressæ¡†æ¶">expressæ¡†æ¶</h3>

<h4 id="å®‰è£…express">å®‰è£…express</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cnpm i express-generator -g //å®‰è£…expressè„šæ‰‹æ¶
express express-test //åˆ›å»ºexpressåº”ç”¨
npm start //è¿è¡Œåº”ç”¨
</code></pre></div></div>

<h4 id="ä¸­é—´ä»¶">ä¸­é—´ä»¶</h4>

<ul>
  <li>ä½¿ç”¨<code class="highlighter-rouge">app.use()</code>æ³¨å†Œä¸­é—´ä»¶</li>
  <li><code class="highlighter-rouge">next()</code>ä¸Šä¸€ä¸ªä¸­é—´ä»¶è§¦å‘ä¸‹ä¸€ä¸ªä¸­é—´ä»¶</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cookieParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cookie-parser</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span><span class="o">=</span><span class="nx">express</span><span class="p">()</span>

<span class="c1">//å¤„ç†è¡¨å•æäº¤æ•°æ®,å°†å¤„ç†åçš„æ•°æ®æŒ‚è½½åˆ°req.bodyä¸­</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span> <span class="na">extended</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}))</span>

<span class="c1">//å¤„ç†jsonæ ¼å¼çš„æ•°æ®</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>

<span class="c1">//å¤„ç†cookie</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cookieParser</span><span class="p">())</span>

<span class="c1">//åˆ›å»ºä¸€ä¸ªè·¯ç”±</span>
<span class="kd">const</span> <span class="nx">router</span><span class="o">=</span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>

<span class="c1">//æ³¨å†Œè·¯ç”±</span>
<span class="kd">const</span> <span class="nx">blogRouter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./routes/blog</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/blog</span><span class="dl">'</span><span class="p">,</span> <span class="nx">blogRouter</span><span class="p">);</span>

<span class="c1">//é€šè¿‡express-sessionå¤„ç†sessionæ•°æ®</span>
<span class="c1">//å®‰è£… cnpm i express-session -S</span>
<span class="c1">//æ³¨å†Œ</span>

<span class="kd">const</span> <span class="nx">session</span> <span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">express-session</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">cookieParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cookie-parser</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cookieParser</span><span class="p">());</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">session</span><span class="p">({</span>
  <span class="na">secret</span><span class="p">:</span><span class="dl">"</span><span class="s2">qwe</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">cookie</span><span class="p">:{</span>
    <span class="na">path</span><span class="p">:</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">,</span><span class="c1">//ä»»æ„è·¯å¾„éƒ½èƒ½è®¿é—®</span>
    <span class="na">httpOnly</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="c1">//æ˜¯å¦å…è®¸ä¿®æ”¹</span>
    <span class="na">maxAge</span><span class="p">:</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="c1">//è¿‡æœŸæ—¶é—´</span>
  <span class="p">}</span>
<span class="p">}))</span>
<span class="c1">//è·å–session</span>
<span class="nx">req</span><span class="p">.</span><span class="nx">session</span>
</code></pre></div></div>

<ul>
  <li>
    <p>è·¯ç”±</p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
  
<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/list</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  	<span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
          
    <span class="p">})</span>
<span class="p">});</span>
  
<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/detail</span><span class="dl">"</span><span class="p">,(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    
<span class="p">})</span>
  
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="ä½¿ç”¨redis">ä½¿ç”¨redis</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//å®‰è£…redis connect-redisæ¨¡å—</span>
<span class="c1">//cnpm i redis connect-redis -S</span>

<span class="c1">//redisçš„é…ç½®</span>
<span class="nx">REDIS_CONF</span><span class="o">=</span><span class="p">{</span>
    <span class="na">port</span><span class="p">:</span><span class="mi">6379</span><span class="p">,</span>
    <span class="na">host</span><span class="p">:</span><span class="dl">"</span><span class="s2">127.0.0.1</span><span class="dl">"</span>
<span class="p">}</span>
<span class="c1">//åˆ›å»ºrediså®¢æˆ·ç«¯</span>
<span class="kd">const</span> <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">redis</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">REDIS_CONF</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">../config/db</span><span class="dl">"</span><span class="p">)</span>
<span class="c1">//åˆ›å»ºå®¢æˆ·ç«¯</span>
<span class="kd">const</span> <span class="nx">redisClient</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="nx">REDIS_CONF</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">REDIS_CONF</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span>
<span class="c1">//ç›‘å¬rediså®¢æˆ·ç«¯æ˜¯å¦äº§ç”Ÿå¼‚å¸¸</span>
<span class="nx">redisClient</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">,</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">})</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">redisClient</span>

<span class="c1">//å°†redisä¸sessionè¿›è¡Œå…³è”</span>
<span class="kd">const</span> <span class="nx">session</span> <span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">express-session</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">RedisStore</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">connect-redis</span><span class="dl">"</span><span class="p">)(</span><span class="nx">session</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">redisClient</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./db/redis</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">sessionStore</span><span class="o">=</span><span class="k">new</span> <span class="nx">RedisStore</span><span class="p">({</span>
  <span class="na">client</span><span class="p">:</span><span class="nx">redisClient</span>
<span class="p">})</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">session</span><span class="p">({</span>
  <span class="na">secret</span><span class="p">:</span><span class="dl">"</span><span class="s2">qwe</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">cookie</span><span class="p">:{</span>
    <span class="na">path</span><span class="p">:</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">,</span><span class="c1">//ä»»æ„è·¯å¾„éƒ½èƒ½è®¿é—®</span>
    <span class="na">httpOnly</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="c1">//æ˜¯å¦å…è®¸ä¿®æ”¹</span>
    <span class="na">maxAge</span><span class="p">:</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="c1">//è¿‡æœŸæ—¶é—´</span>
  <span class="p">},</span>
  <span class="na">store</span><span class="p">:</span><span class="nx">sessionStore</span>
<span class="p">}))</span>
</code></pre></div></div>

<h4 id="æ—¥å¿—">æ—¥å¿—</h4>

<ul>
  <li>
    <p>ä½¿ç”¨æ¨¡å—<code class="highlighter-rouge">morgan</code>å®Œæˆæ—¥å¿—çš„è¾“å‡º</p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//morgançš„ç®€ä»‹https://github.com/expressjs/morgan</span>
<span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">morgan</span><span class="dl">'</span><span class="p">);</span>
<span class="cm">/*
	ç¯å¢ƒç±»å‹
	"scripts": {
    "start": "node ./bin/www",
    "dev": "cross-env NODE_ENV=dev nodemon ./bin/www.js",
    "prd": "cross-env NODE_ENV=production nodemon ./bin/www.js"
  }
*/</span>
  
<span class="kd">const</span> <span class="nx">ENV</span><span class="o">=</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="c1">//è·å–ç¯å¢ƒç±»å‹</span>
<span class="k">if</span><span class="p">(</span><span class="nx">ENV</span><span class="o">!==</span><span class="dl">"</span><span class="s2">production</span><span class="dl">"</span><span class="p">){</span>
   <span class="c1">//å¼€å‘ç¯å¢ƒ/æµ‹è¯•ç¯å¢ƒ</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">logger</span><span class="p">(</span><span class="dl">'</span><span class="s1">dev</span><span class="dl">'</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">else</span><span class="p">{</span>
    <span class="c1">//çº¿ä¸Šç¯å¢ƒ</span>
  <span class="kd">const</span> <span class="nx">logFilename</span><span class="o">=</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="dl">"</span><span class="s2">logs</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">access.log</span><span class="dl">"</span><span class="p">)</span><span class="c1">//æ‹¼æ¥æ–‡ä»¶è·¯å¾„</span>
  <span class="kd">const</span> <span class="nx">writeStream</span><span class="o">=</span><span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="nx">logFilename</span><span class="p">,{</span>
    <span class="na">flags</span><span class="p">:</span><span class="dl">"</span><span class="s2">a</span><span class="dl">"</span>
  <span class="p">})</span><span class="c1">//åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æ—¥å¿—å†™å…¥æµ</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">logger</span><span class="p">(</span><span class="dl">"</span><span class="s2">combined</span><span class="dl">"</span><span class="p">,{</span>
    <span class="na">stream</span><span class="p">:</span><span class="nx">writeStream</span><span class="c1">//å°†æ—¥å¿—å†™æ–‡ä»¶</span>
  <span class="p">}))</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="expresså®ç°åŸç†">expresså®ç°åŸç†</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">http</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">http</span><span class="dl">"</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">slice</span><span class="o">=</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">;</span>

<span class="kd">class</span> <span class="nx">LikeExpress</span><span class="p">{</span>
    <span class="kd">constructor</span><span class="p">(){</span>
        <span class="c1">//å­˜æ”¾ä¸­é—´ä»¶çš„åˆ—è¡¨</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="o">=</span><span class="p">{</span>
            <span class="na">all</span><span class="p">:[],</span><span class="c1">//å­˜æ”¾ä½¿ç”¨useæ³¨å†Œçš„ä¸­é—´ä»¶</span>
            <span class="na">get</span><span class="p">:[],</span><span class="c1">//å­˜æ”¾ä½¿ç”¨getæ³¨å†Œçš„ä¸­é—´ä»¶</span>
            <span class="na">post</span><span class="p">:[]</span><span class="c1">//å­˜æ”¾ä½¿ç”¨postæ³¨å†Œçš„ä¸­é—´ä»¶</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">register</span><span class="p">(</span><span class="nx">path</span><span class="p">){</span>
        <span class="kd">const</span> <span class="nx">info</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">path</span><span class="o">===</span><span class="dl">"</span><span class="s2">string</span><span class="dl">"</span><span class="p">){</span>
            <span class="nx">info</span><span class="p">.</span><span class="nx">path</span><span class="o">=</span><span class="nx">path</span><span class="p">;</span>

            <span class="c1">//ä»ç¬¬äºŒä¸ªå‡½æ•°å¼€å§‹ï¼Œè½¬æ¢ä¸ºæ•°ç»„ï¼Œå­˜å…¥stackä¸­</span>
            <span class="nx">info</span><span class="p">.</span><span class="nx">stack</span><span class="o">=</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1">//æ•°ç»„</span>


            <span class="c1">//argumentsæ˜¯ç±»æ•°ç»„å¯¹è±¡ï¼Œæœ‰ä¸€äº›æ•°ç»„ä¸­çš„æ–¹æ³•å®ƒä»¬æ˜¯æ²¡æœ‰çš„</span>
        <span class="p">}</span>
        <span class="k">else</span><span class="p">{</span>
            <span class="nx">info</span><span class="p">.</span><span class="nx">path</span><span class="o">=</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span>
            <span class="c1">//ä»ç¬¬äºŒä¸ªå‡½æ•°å¼€å§‹ï¼Œè½¬æ¢ä¸ºæ•°ç»„ï¼Œå­˜å…¥stackä¸­</span>
            <span class="nx">info</span><span class="p">.</span><span class="nx">stack</span><span class="o">=</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1">//æ•°ç»„</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">info</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">use</span><span class="p">(){</span>
        <span class="kd">const</span> <span class="nx">info</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">register</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">arguments</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">all</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">info</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">get</span><span class="p">(){</span>
        <span class="kd">const</span> <span class="nx">info</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">register</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">arguments</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">info</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">post</span><span class="p">(){</span>
        <span class="kd">const</span> <span class="nx">info</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">register</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">arguments</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">info</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">match</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span><span class="nx">url</span><span class="p">){</span>
        <span class="kd">let</span> <span class="nx">stack</span><span class="o">=</span><span class="p">[]</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">url</span><span class="o">===</span><span class="dl">'</span><span class="s1">/favicon.ico</span><span class="dl">'</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">stack</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//è·å–routes</span>
        <span class="kd">let</span> <span class="nx">curRoutes</span><span class="o">=</span><span class="p">[]</span>
        <span class="nx">curRoutes</span><span class="o">=</span><span class="nx">curRoutes</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">all</span><span class="p">)</span>
        <span class="nx">curRoutes</span><span class="o">=</span><span class="nx">curRoutes</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">[</span><span class="nx">method</span><span class="p">])</span>


        <span class="nx">curRoutes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">item</span><span class="o">=&gt;</span><span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span><span class="o">===</span><span class="mi">0</span><span class="p">){</span>
                <span class="nx">stack</span><span class="o">=</span><span class="nx">stack</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">stack</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="nx">stack</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//æ ¸å¿ƒçš„nextæœºåˆ¶</span>
    <span class="nx">handle</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">stack</span><span class="p">){</span>
        <span class="kd">const</span> <span class="nx">next</span><span class="o">=</span><span class="p">()</span><span class="o">=&gt;</span><span class="p">{</span>
            <span class="c1">//ç¬¬ä¸€ä¸ªåŒ¹é…çš„ä¸­é—´ä»¶</span>
            <span class="kd">const</span> <span class="nx">middleware</span><span class="o">=</span><span class="nx">stack</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>

            <span class="k">if</span><span class="p">(</span><span class="nx">middleware</span><span class="p">){</span>
                <span class="c1">//æ‰§è¡Œä¸­é—´ä»¶å‡½æ•°</span>
                <span class="nx">middleware</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">next</span><span class="p">()</span>
    <span class="p">}</span>


    <span class="nx">callback</span><span class="p">(){</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="o">=</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-type</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span><span class="p">)</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span>
                    <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">}</span>

            <span class="kd">const</span> <span class="nx">url</span><span class="o">=</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span>
            <span class="kd">const</span> <span class="nx">method</span><span class="o">=</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>


            <span class="kd">const</span> <span class="nx">resultList</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span><span class="nx">url</span><span class="p">)</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">handle</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">resultList</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">listen</span><span class="p">(...</span><span class="nx">args</span><span class="p">){</span>
        <span class="kd">const</span> <span class="nx">server</span><span class="o">=</span><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">())</span>
        <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="c1">//å·¥å‚å‡½æ•°</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="p">()</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">LikeExpress</span><span class="p">();</span>
<span class="p">}</span>


<span class="c1">//æµç¨‹å‰ç«¯å‘é€è¯·æ±‚-&gt;listen-&gt;callback-&gt;match-&gt;handle</span>
</code></pre></div></div>

<h3 id="koa2æ¡†æ¶">koa2æ¡†æ¶</h3>

<ul>
  <li>expressä¸­é—´ä»¶æ˜¯å¼‚æ­¥å›è°ƒï¼Œkoa2åŸç”Ÿæ”¯æŒ<code class="highlighter-rouge">async/await</code></li>
  <li><a href="https://koa.bootcss.com/">ç®€ä»‹</a></li>
</ul>

<h4 id="å®‰è£…">å®‰è£…</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">koa2</span><span class="err">çš„è„šæ‰‹æ¶</span> <span class="nx">npm</span> <span class="nx">i</span> <span class="nx">koa</span><span class="o">-</span><span class="nx">generator</span> <span class="o">-</span><span class="nx">g</span>
<span class="err">åˆå§‹åŒ–ç¯å¢ƒ</span> <span class="nx">Koa2</span> <span class="nx">koa2</span><span class="o">-</span><span class="nx">test</span><span class="p">(</span><span class="err">æ–‡ä»¶æ¶åå­—</span><span class="p">)</span>
<span class="err">å¯åŠ¨</span> <span class="nx">npm</span> <span class="nx">i</span> <span class="o">&amp;</span> <span class="nx">npm</span> <span class="nx">run</span> <span class="nx">dev</span> 
</code></pre></div></div>

<h4 id="ä¸­é—´ä»¶-1">ä¸­é—´ä»¶</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Koa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">koa</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Koa</span><span class="p">()</span>

<span class="c1">//å‡ºè·¯jsonæ ¼å¼æ•°æ®</span>
<span class="kd">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">koa-json</span><span class="dl">'</span><span class="p">)</span>
<span class="c1">//é”™è¯¯å¤„ç†</span>
<span class="kd">const</span> <span class="nx">onerror</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">koa-onerror</span><span class="dl">'</span><span class="p">)</span>
<span class="c1">//å¤„ç†è¡¨å•æäº¤çš„æ•°æ®</span>
<span class="kd">const</span> <span class="nx">bodyparser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">koa-bodyparser</span><span class="dl">'</span><span class="p">)</span>
<span class="c1">// æ—¥å¿—ç¾åŒ–</span>
<span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">koa-logger</span><span class="dl">'</span><span class="p">)</span>

<span class="c1">//å¼•å…¥è·¯ç”±</span>
<span class="kd">const</span> <span class="nx">blog</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./routes/blog</span><span class="dl">"</span><span class="p">)</span>

<span class="c1">// error handler</span>
<span class="nx">onerror</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>

<span class="c1">// å¤„ç†è¡¨å•æäº¤</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyparser</span><span class="p">({</span>
  <span class="na">enableTypes</span><span class="p">:[</span><span class="dl">'</span><span class="s1">json</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">form</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">text</span><span class="dl">'</span><span class="p">]</span>
<span class="p">}))</span>

<span class="c1">//å¤„ç†jsonæ ¼å¼æ•°æ®</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">json</span><span class="p">())</span>

<span class="c1">//å¤„ç†æ—¥å¿—</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">logger</span><span class="p">())</span>


<span class="c1">// æ—¥å¿—å¤„ç†</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
  <span class="k">await</span> <span class="nx">next</span><span class="p">()</span>
  <span class="kd">const</span> <span class="nx">ms</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">-</span> <span class="nx">start</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">method</span><span class="p">}</span><span class="s2"> </span><span class="p">${</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">url</span><span class="p">}</span><span class="s2"> - </span><span class="p">${</span><span class="nx">ms</span><span class="p">}</span><span class="s2">ms`</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1">// è·¯ç”±æ³¨å†Œ</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">blog</span><span class="p">.</span><span class="nx">routes</span><span class="p">(),</span> <span class="nx">blog</span><span class="p">.</span><span class="nx">allowedMethods</span><span class="p">())</span>

<span class="c1">// é”™è¯¯å¤„ç†</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">server error</span><span class="dl">'</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">app</span>
</code></pre></div></div>

<ul>
  <li>
    <p>è·¯ç”±</p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">koa-router</span><span class="dl">'</span><span class="p">)()</span>
  
<span class="nx">router</span><span class="p">.</span><span class="nx">prefix</span><span class="p">(</span><span class="dl">"</span><span class="s2">/api/blog</span><span class="dl">"</span><span class="p">);</span><span class="c1">//è®¾ç½®è¯·æ±‚è·¯å¾„çš„å‰ç¼€</span>
  
<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/list</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span><span class="c1">//ç›¸ç­‰äºreq.queryè¿”å›æŸ¥è¯¢å­—ç¬¦ä¸²</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="p">{</span><span class="c1">//ç›¸å½“äº</span>
        <span class="na">error</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">query</span><span class="p">,</span>
        <span class="na">data</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">è·å–åšå®¢åˆ—è¡¨</span><span class="dl">"</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">})</span>
  
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="koaä¸­çš„session">koaä¸­çš„session</h4>

<ul>
  <li>
    <p>åŸºäºkoa-generic-sessionå’Œkoa-redis</p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//å®‰è£…æ’ä»¶ cnpm i koa-generic-session koa-redis redis -S</span>
  
<span class="c1">//å¤„ç†session</span>
<span class="kd">const</span> <span class="nx">session</span> <span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">koa-generic-session</span><span class="dl">"</span><span class="p">)</span>
  
<span class="c1">//å¤„ç†redisï¼Œè¿™ä¸ªæ¨¡å—ä¾èµ–redis</span>
<span class="kd">const</span> <span class="nx">redisStore</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">koa-redis</span><span class="dl">"</span><span class="p">)</span>
  
<span class="c1">// è®¾ç½®ç­¾åçš„å¯†é’¥</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">keys</span><span class="o">=</span><span class="p">[</span><span class="dl">"</span><span class="s2">123</span><span class="dl">"</span><span class="p">]</span>
<span class="c1">//è®¾ç½®sessionï¼Œå¹¶å°†sessionä¸rediså…³è”</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">session</span><span class="p">({</span>
  <span class="na">cookie</span><span class="p">:{</span>
    <span class="na">path</span><span class="p">:</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">,</span><span class="c1">//æ‰€æœ‰çš„è·¯ç”±éƒ½èƒ½ä½¿ç”¨</span>
    <span class="na">httpOnly</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="c1">//ä¸å…è®¸å‰ç«¯ä¿®æ”¹</span>
    <span class="na">maxAge</span><span class="p">:</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="c1">//æœ‰æ•ˆæ—¶é—´</span>
  <span class="p">},</span>
  <span class="na">store</span><span class="p">:</span><span class="nx">redisStore</span><span class="p">({</span>
    <span class="na">all</span><span class="p">:</span><span class="dl">'</span><span class="s1">127.0.0.1:6379</span><span class="dl">'</span>
  <span class="p">})</span><span class="c1">//é…ç½®redis</span>
<span class="p">}))</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="æ—¥å¿—-1">æ—¥å¿—</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//å®‰è£…å…¼å®¹æ¨¡å—ï¼ˆmorganæ˜¯expressä¸­çš„æ¨¡å—ï¼‰cnpm i koa-morgan -S</span>
<span class="cm">/*
	ç¯å¢ƒç±»å‹
	"scripts": {
    "start": "node ./bin/www",
    "dev": "cross-env NODE_ENV=dev nodemon ./bin/www.js",
    "prd": "cross-env NODE_ENV=production nodemon ./bin/www.js"
  }
*/</span>
<span class="kd">const</span> <span class="nx">path</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">path</span><span class="dl">"</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">fs</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">fs</span><span class="dl">"</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">morgan</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">koa-morgan</span><span class="dl">"</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">ENV</span><span class="o">=</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span>
<span class="k">if</span><span class="p">(</span><span class="nx">ENV</span><span class="o">!==</span><span class="dl">"</span><span class="s2">production</span><span class="dl">"</span><span class="p">){</span>
  <span class="c1">//å¼€å‘ç¯å¢ƒ</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">morgan</span><span class="p">(</span><span class="dl">'</span><span class="s1">dev</span><span class="dl">'</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">else</span><span class="p">{</span>
  <span class="c1">//çº¿ä¸Šç¯å¢ƒ</span>

  <span class="kd">const</span> <span class="nx">logFilename</span><span class="o">=</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="dl">"</span><span class="s2">logs</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">access.log</span><span class="dl">"</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">writeStream</span><span class="o">=</span><span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="nx">logFilename</span><span class="p">,{</span>
    <span class="na">flags</span><span class="p">:</span><span class="dl">"</span><span class="s2">a</span><span class="dl">"</span>
  <span class="p">})</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">morgan</span><span class="p">(</span><span class="dl">"</span><span class="s2">combined</span><span class="dl">"</span><span class="p">,{</span>
    <span class="na">stream</span><span class="p">:</span><span class="nx">writeStream</span>
  <span class="p">}))</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="koa2å®ç°åŸç†">koa2å®ç°åŸç†</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">http</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">http</span><span class="dl">"</span><span class="p">)</span>
<span class="c1">//ç»„åˆä¸­é—´ä»¶</span>
<span class="kd">function</span> <span class="nx">compose</span><span class="p">(</span><span class="nx">middlewareList</span><span class="p">){</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">){</span>
        <span class="c1">//ä¸­é—´çš„è°ƒç”¨</span>

        <span class="kd">function</span> <span class="nx">dispatch</span><span class="p">(</span><span class="nx">i</span><span class="p">){</span>
            <span class="kd">const</span> <span class="nx">fn</span><span class="o">=</span><span class="nx">middlewareList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>

            <span class="k">try</span><span class="p">{</span>
                <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span>
                    <span class="nx">fn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="nx">dispatch</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
                <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span>
                    <span class="nx">err</span>
                <span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">dispatch</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nx">LikeKoa2</span><span class="p">{</span>
    <span class="kd">constructor</span><span class="p">(){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">middlewareList</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">}</span>

    <span class="nx">use</span><span class="p">(</span><span class="nx">fn</span><span class="p">){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">middlewareList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">this</span>
    <span class="p">}</span>

    <span class="nx">createContext</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">){</span>
        <span class="kd">const</span> <span class="nx">ctx</span><span class="o">=</span><span class="p">{</span>
            <span class="nx">req</span><span class="p">,</span><span class="nx">res</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span>
    <span class="p">}</span>


    <span class="nx">handleRequest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="nx">fn</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">callback</span><span class="p">(){</span>
        <span class="kd">const</span> <span class="nx">fn</span><span class="o">=</span><span class="nx">compose</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">middlewareList</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
            <span class="kd">const</span> <span class="nx">ctx</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">createContext</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleRequest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="nx">fn</span><span class="p">)</span>

        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">listen</span><span class="p">(...</span><span class="nx">args</span><span class="p">){</span>
        <span class="kd">const</span> <span class="nx">server</span><span class="o">=</span><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">())</span>

        <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">LikeKoa2</span>
</code></pre></div></div>

:ET